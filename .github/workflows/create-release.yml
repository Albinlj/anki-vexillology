name: Create Anki Deck Release

on:
  workflow_dispatch:
  schedule:
    # Run monthly on the 1st at 00:00 UTC to get updated flag information
    - cron: '0 0 1 * *'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download flags
        run: |
          python download_flags.py
          echo "Downloaded $(ls -1 flags/ | wc -l) flag images"
      
      - name: Create Anki deck
        run: |
          python create_anki_deck.py
          if [ -f National_Flags.apkg ]; then
            echo "Successfully created Anki deck"
            ls -lh National_Flags.apkg
          else
            echo "Error: Anki deck file not created"
            exit 1
          fi
      
      - name: Generate release tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Use existing tag if triggered by tag push
            TAG=${GITHUB_REF#refs/tags/}
          else
            # Generate tag based on current date
            TAG="release-$(date +'%Y.%m.%d')"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: National Flags Anki Deck - ${{ steps.tag.outputs.tag }}
          body: |
            # National Flags Anki Deck
            
            This release contains an Anki flashcard deck for learning national flags of sovereign states.
            
            ## What's Included
            
            - **National_Flags.apkg**: Anki deck with flags of all sovereign states
            - Each card contains:
              - Front: Flag image
              - Back: Country name, flag image, description with symbolism, and adoption date
            
            ## How to Use
            
            1. Download `National_Flags.apkg` from the assets below
            2. Open Anki
            3. Go to File > Import
            4. Select the downloaded `National_Flags.apkg` file
            5. Start learning!
            
            ## Data Source
            
            Flag information is scraped from Wikipedia's [List of national flags of sovereign states](https://en.wikipedia.org/wiki/List_of_national_flags_of_sovereign_states).
            
            ---
            
            Generated on: ${{ github.event.head_commit.timestamp || github.run_started_at }}
          files: |
            National_Flags.apkg
          draft: false
          prerelease: false
